version: 3
includes:
  core: .task/core/
env:
  VERSION: "0.0.0"
vars:
  PROJECT: '{{ .PROJECT | default "my-project" }}'
tasks:
  init:
    - task: core:init
    - task: init:python
  init:python:
    desc: Install required application dependencies
    sources:
      - requirements.txt
    cmds:
      - pip3 install -r requirements.txt

  start:
    desc: Bootstrap the server and load from config
    deps: [init:python]
    cmds:
      - ./main.py --dev

  update: [{ task: "core:update" }]
  clean: [{ task: "core:clean" }]

  # -------------------------------------------------
  # Example commands
  # -------------------------------------------------
  example:
    desc: A fairly complex example task
    vars:
      MESSAGE: '{{ .MESSAGE | default "Hello World" }}'
      OUTPUT_PATH: ./dist/lala.txt
    cmds:
      - echo "{{ .MESSAGE }}"
      - task: example:alpha
      - task: example:beta
      - task: example:delta
      - echo Done
  example:alpha:
    desc: First example task
    sources:
      - Taskfile.yaml
    generates:
      - "./dist/lala.txt"
    cmds:
      - mkdir -p ./dist
      - cat Taskfile.yaml > ./dist/lala.txt
  example:beta:
    desc: Second example task
    cmds:
      - sleep 1
  example:delta:
    - echo "Updating sources..."
    - |-
      echo "Sleep for 1 second..."
      sleep 1
  example:fail:
    desc: Explicitly exit with exit status
    cmds:
      - echo "Crashing this task..." 1>&2
      - exit 2
      - echo "Technically this command should never run."
  example:complex:
    desc: Explicitly exit with exit status
    cmds:
      - task: example:alpha
      - task: example:beta
      - task: example:delta
      - task: example:delta
      - task: example:fail
      - task: example:delta
  example:infinite:
    desc: Run this task indefinately
    cmds:
      - echo "Starting infinite loop"
      - |-
        count=1
        while true; 
        do 
          echo $count
          sleep 2
          count=$(( $count + 1 ))
        done
  example:repeats:
    desc: Run the same command repeatedly
    cmds:
      - echo "Sleeping 5 times..."
      - sleep 1
      - sleep 1
      - sleep 1
      - sleep 1
      - sleep 1
      - echo "Done"